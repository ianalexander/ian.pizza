<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content=""><meta name="author" content=""><title> ian.pizza</title><link rel="stylesheet" href="/css/style.css"><meta name="layout" content="b/2013/04/10/building-a-true-oauth-20-api-with-django-and-tasty-pie/index.html"><script>var disqus_config = function () {
    this.page.url = url;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = path; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
(function() {  // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    
    s.src = '//ianalexandr.disqus.com/embed.js';
    
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
})();</script></head><body><div id="container"><div id="nav"><div class="navItems"><div><a href="/">h</a> / <a href="/b">b</a></div><div><a href="https://www.facebook.com/ian.m.alexander">fb</a> / <a href="https://www.snapchat.com/add/ianalexan">sc</a> / <a href="http://instagram.com/ianalexan">ig</a> / <a href="https://github.com/ianalexander">gh</a> / <a href="https://www.linkedin.com/in/ianmalexander">li</a></div></div></div><div id="cover"><div id="title"><h1>Building a True OAuth 2.0 API with Django and Tasty Pie</h1><span> Apr 10 2013</span></div></div><div id="content"><p>Almost a year ago PyDanny wrote a great article entitled “<a href="http://pydanny.com/the-sorry-state-of-python-oauth-providers.html" target="_blank" rel="external">The Sorry State of Python OAuth Providers</a>“ detailing the abysmal state of OAuth in Python. One year later we have a few more options, and here I am going to detail how I made a django-based OAuth 2.0 API with Tasty Pie.</p>
<h2 id="Getting-Started"><a href="#Getting-Started" class="headerlink" title="Getting Started"></a>Getting Started</h2><p>First things first, I cannot recommend enough the <a href="https://github.com/Mashape/mashape-oauth/blob/master/FLOWS.md" target="_blank" rel="external">Mashape OAuth Bible</a> enough. It is currently the most comprehensive document I have found covering both OAuth 1 and 2, and the various flows involved with each. Read up before you get started! We’ll be using various components to put our API together:</p>
<ul>
<li>CaffieneHit’s <a href="https://github.com/caffeinehit/django-oauth2-provider" target="_blank" rel="external">django-oauth2-provider</a> library will provide out-of-the-box OAuth provisioning capabilities</li>
<li><a href="http://tastypieapi.org/" target="_blank" rel="external">Tasty Pie</a> will create the API</li>
<li>My <a href="https://github.com/ianalexander/django-oauth2-tastypie" target="_blank" rel="external">django-oauth2-tastypie</a> library will marry the two together</li>
</ul>
<p>I’ll be using the classic django “Polls and Choices” models as my examples.</p>
<h2 id="Setting-up-Django"><a href="#Setting-up-Django" class="headerlink" title="Setting up Django"></a>Setting up Django</h2><p>First things first, we need to create a new django project and create the essential models.</p>
<pre><code class="bash">$ django-admin.py startproject mysite
$ cd mysite/
$ python manage.py startapp polls
</code></pre>
<pre><code class="python"># mysite/polls/models.py
from django.db import models

class Poll(models.Model):
    question = models.CharField(max_length=200)
    pub_date = models.DateTimeField(&#39;date published&#39;)
    def __unicode__(self):
        return self.question

class Choice(models.Model):
    poll = models.ForeignKey(Poll)
    choice_text = models.CharField(max_length=200)
    votes = models.IntegerField(default=0)
    def __unicode(self):
        return self.choice_text
</code></pre>
<pre><code class="python"># mysite/polls/settings.py
INSTALLED_APPS = (
    ...
    &#39;django.contrib.admin&#39;
    &#39;polls&#39;,
)
</code></pre>
<p>Make sure you also add your database configuration and syncdb to add a new user. No surprises here!</p>
<h2 id="Setting-up-the-Provider"><a href="#Setting-up-the-Provider" class="headerlink" title="Setting up the Provider"></a>Setting up the Provider</h2><p>First we’re going to install the provider.</p>
<pre><code class="bash">$ sudo pip install django-oauth2-provider
</code></pre>
<p>Next, add the two lines to add the default providers (which should be fine for most use-cases).</p>
<pre><code class="python"># mysite/polls/settings.py
INSTALLED_APPS = (
    ...
    &#39;django.contrib.admin&#39;
    &#39;polls&#39;,
    &#39;provider&#39;,
    &#39;provider.oauth2&#39;,
)
</code></pre>
<p>Include provider.oauth2.urls into your urls.py file (<code>namespace=&#39;oauth2&#39;</code> is required!). Uncomment the admin lines at the top of the file for ease of working with tokens and clients.</p>
<pre><code class="python"># mysite/polls/urls.py
from django.contrib import admin
admin.autodiscover()
...
url(r&#39;^oauth2/&#39;, include(&#39;provider.oauth2.urls&#39;, namespace = &#39;oauth2&#39;)),
</code></pre>
<p>Finally, use the admin console to add a new Client. Or you can do it programatically:</p>
<pre><code class="pycon">&gt;&gt;&gt; from provider.oauth2.models import Client
&gt;&gt;&gt; from django.contrib.auth.models import User
&gt;&gt;&gt; u = User.objects.get(id=1)
&gt;&gt;&gt; c = Client(user=u, name=&quot;mysite client&quot;, client_type=1, url=&quot;http://ianalexandr.com&quot;)
&gt;&gt;&gt; c.save()
&gt;&gt;&gt; c.client_id
&#39;d63f53a7a6cceba04db5&#39;
&gt;&gt;&gt; c.client_secret
&#39;afe899288b9ac4127d57f2f12ac5a49d839364dc&#39;
</code></pre>
<h2 id="Testing-the-Provider"><a href="#Testing-the-Provider" class="headerlink" title="Testing the Provider"></a>Testing the Provider</h2><p>Now we can launch the server and test the OAuth Provider. We’ll be using the <a href="https://github.com/Mashape/mashape-oauth/blob/master/FLOWS.md#oauth-2-two-legged" target="_blank" rel="external">Two-Legged Resource Owner Password</a> flow.</p>
<pre><code class="bash">$ python manage.py runserver

$ curl -d &quot;client_id=d63f53a7a6cceba04db5&amp;client_secret=afe899288b9ac4127d57f2f12ac5a49d839364dc&amp;grant_type=password&amp;username=ian&amp;password=straightflexin&amp;scope=write&quot; http://localhost:8000/oauth2/access_token
{&quot;access_token&quot;: &quot;a832106c17d00fd3b9094181c598820ef3ff76f4&quot;, &quot;scope&quot;: &quot;read write&quot;, &quot;expires_in&quot;: 86399, &quot;refresh_token&quot;: &quot;bfdbd5510ae724a2dbd458e68274ab5c8590d3e4&quot;}
</code></pre>
<p>If you see the access_token, voila! It’s working! Verify the access_token is stored in your database:</p>
<pre><code class="pycon">&gt;&gt;&gt; from provider.oauth2.models import AccessToken
&gt;&gt;&gt; AccessToken.objects.all()
[&lt;AccessToken: a832106c17d00fd3b9094181c598820ef3ff76f4&gt;]
</code></pre>
<h2 id="Setting-up-the-API"><a href="#Setting-up-the-API" class="headerlink" title="Setting up the API"></a>Setting up the API</h2><p>Now let’s add Tasty Pie to the mix. First things first:</p>
<pre><code class="bash">$ sudo pip install django-tastypie
</code></pre>
<pre><code class="python"># mysite/polls/settings.py
INSTALLED_APPS = (
    ...
    &#39;django.contrib.admin&#39;
    &#39;polls&#39;,
    &#39;provider&#39;,
    &#39;provider.oauth2&#39;,
    &#39;tastypie&#39;,
)
</code></pre>
<p>Now we need to add the appropriate Resources to our to our application. I like to use <code>polls/api.py</code> but these classes can live anywhere. Once the Resources are created, we’ll add them to our <code>urls.py</code> using the <code>Api()</code> class to bind multiple resources together.</p>
<pre><code class="python"># mysite/polls/api.py
from tastypie.resources import ModelResource
from polls.models import Poll, Choice
from tastypie import fields

class ChoiceResource(ModelResource):
    class Meta:
        queryset = Choice.objects.all()
        resource_name = &#39;choice&#39;

class PollResource(ModelResource):
    choices = fields.ToManyField(ChoiceResource, &#39;choice_set&#39;, full=True)
    class Meta:
        queryset = Poll.objects.all()
        resource_name = &#39;poll&#39;
</code></pre>
<pre><code class="python"># mysite/mysite/urls.py
from django.conf.urls import patterns, include, url
from django.contrib import admin
admin.autodiscover()

from tastypie.api import Api
from polls.api import PollResource, ChoiceResource

v1_api = Api(api_name=&#39;v1&#39;)
v1_api.register(PollResource())
v1_api.register(ChoiceResource())

urlpatterns = patterns(&#39;&#39;,
    url(r&#39;^admin/&#39;, include(admin.site.urls)),
    url(r&#39;^oauth2/&#39;, include(&#39;provider.oauth2.urls&#39;, namespace = &#39;oauth2&#39;)),
    url(r&#39;^api/&#39;, include(v1_api.urls)),
)
</code></pre>
<p>Now let’s test our our API!</p>
<pre><code class="bash">$ curl http://127.0.0.1:8000/api/v1/?format=json
{&quot;choice&quot;: {&quot;list_endpoint&quot;: &quot;/api/v1/choice/&quot;, &quot;schema&quot;: &quot;/api/v1/choice/schema/&quot;}, &quot;poll&quot;: {&quot;list_endpoint&quot;: &quot;/api/v1/poll/&quot;, &quot;schema&quot;: &quot;/api/v1/poll/schema/&quot;}}
</code></pre>
<p>Looks like it’s working, let’s add an object and test the other endpoints:</p>
<pre><code class="pycon">&gt;&gt;&gt; from polls.models import *
&gt;&gt;&gt; import datetime
&gt;&gt;&gt; p = Poll(question=&quot;All gold everything?&quot;, pub_date=datetime.datetime.now())
&gt;&gt;&gt; p.choice_set.create(choice_text=&#39;Chain&#39;, votes=0)
&lt;Choice: Choice object&gt;
&gt;&gt;&gt; p.choice_set.create(choice_text=&#39;Ring&#39;, votes=0)
&lt;Choice: Choice object&gt;
&gt;&gt;&gt; p.choice_set.create(choice_text=&#39;Watch&#39;, votes=0)
&lt;Choice: Choice object&gt;
&gt;&gt;&gt; p.save()
</code></pre>
<pre><code class="bash">$ curl http://127.0.0.1:8000/api/v1/poll/?format=json
{&quot;meta&quot;: {&quot;limit&quot;: 20, &quot;next&quot;: null, &quot;offset&quot;: 0, &quot;previous&quot;: null, &quot;total_count&quot;: 1}, &quot;objects&quot;: [{&quot;choices&quot;: [{&quot;choice_text&quot;: &quot;Chain&quot;, &quot;id&quot;: 1, &quot;resource_uri&quot;: &quot;/api/v1/choice/1/&quot;, &quot;votes&quot;: 0}, {&quot;choice_text&quot;: &quot;Ring&quot;, &quot;id&quot;: 2, &quot;resource_uri&quot;: &quot;/api/v1/choice/2/&quot;, &quot;votes&quot;: 0}, {&quot;choice_text&quot;: &quot;Watch&quot;, &quot;id&quot;: 3, &quot;resource_uri&quot;: &quot;/api/v1/choice/3/&quot;, &quot;votes&quot;: 0}], &quot;id&quot;: 1, &quot;pub_date&quot;: &quot;2013-04-10T12:38:47.337475&quot;, &quot;question&quot;: &quot;All gold everything?&quot;, &quot;resource_uri&quot;: &quot;/api/v1/poll/1/&quot;}]}
</code></pre>
<h2 id="Authenticating-with-django-oauth2-tastypie"><a href="#Authenticating-with-django-oauth2-tastypie" class="headerlink" title="Authenticating with django-oauth2-tastypie"></a>Authenticating with django-oauth2-tastypie</h2><p>Now we have an OAuth 2.0 provider and an API. Next we’ll need to tell Tasty Pie to accept tokens, and to use django-oauth2-provider to validate the tokens.</p>
<p>Briefly before we get started: what is the difference between <strong>authentication</strong> and <strong>authorization</strong>? <strong>Authentication</strong> answers the question, “Who is this person?” Authentication deals with usernames and passwords, OAuth Tokens, API Keys, and other means of identification. <strong>Authorization</strong> answers the question “Is this person allowed to perfom this action”? Authorizaton deals with permissions, and access limitations.</p>
<p>First take a look at the <code>OAuth20Authentication</code> class in <a href="https://github.com/ianalexander/django-oauth2-tastypie" target="_blank" rel="external">django-oauth2-tastypie</a>. Copy (or clone) <code>authenticate.py</code> into your <code>mysite/polls/</code> directory.</p>
<p>Next, modify your <code>api.py</code> file to use the new <code>Authentication</code> class (and the <code>DjangoAuthrorization</code> class for good measure).</p>
<pre><code class="python"># mysite/polls/api.py
from tastypie.resources import ModelResource
from tastypie.authorization import DjangoAuthorization
from polls.models import Poll, Choice
from tastypie import fields
from authentication import OAuth20Authentication

class ChoiceResource(ModelResource):
    class Meta:
        queryset = Choice.objects.all()
        resource_name = &#39;choice&#39;
        authorization = DjangoAuthorization()
        authentication = OAuth20Authentication()

class PollResource(ModelResource):
    choices = fields.ToManyField(ChoiceResource, &#39;choice_set&#39;, full=True)
    class Meta:
        queryset = Poll.objects.all()
        resource_name = &#39;poll&#39;
        authorization = DjangoAuthorization()
        authentication = OAuth20Authentication()
</code></pre>
<p>Now let’s try to access our API again.</p>
<pre><code class="bash">$ curl -v http://127.0.0.1:8000/api/v1/poll/?format=json
* About to connect() to 127.0.0.1 port 8000 (#0)
*   Trying 127.0.0.1... connected
&gt; GET /api/v1/poll/?format=json HTTP/1.1
&gt; User-Agent: curl/7.22.0 (x86_64-pc-linux-gnu) libcurl/7.22.0 OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3
&gt; Host: 127.0.0.1:8000
&gt; Accept: */*
&gt;
* HTTP 1.0, assume close after body
&lt; HTTP/1.0 401 UNAUTHORIZED
&lt; Date: Thu, 11 Apr 2013 00:25:46 GMT
&lt; Server: WSGIServer/0.1 Python/2.7.3
&lt; Content-Type: text/html; charset=utf-8
&lt;
* Closing connection #0
</code></pre>
<p>Access Denied! Now let’s add our Access Token to the Authorize header and try again.</p>
<pre><code class="bash">$ curl -v -H &quot;Authorization: OAuth a832106c17d00fd3b9094181c598820ef3ff76f4&quot; http://127.0.0.1:8000/api/v1/poll/?format=json
* About to connect() to 127.0.0.1 port 8000 (#0)
*   Trying 127.0.0.1... connected
&gt; GET /api/v1/poll/?format=json HTTP/1.1
&gt; User-Agent: curl/7.22.0 (x86_64-pc-linux-gnu) libcurl/7.22.0 OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3
&gt; Host: 127.0.0.1:8000
&gt; Accept: */*
&gt; Authorization: OAuth a832106c17d00fd3b9094181c598820ef3ff76f4
&gt;
* HTTP 1.0, assume close after body
&lt; HTTP/1.0 200 OK
&lt; Date: Thu, 11 Apr 2013 00:27:42 GMT
&lt; Server: WSGIServer/0.1 Python/2.7.3
&lt; Vary: Accept
&lt; Content-Type: application/json
&lt; Cache-Control: no-cache
&lt;
* Closing connection #0
{&quot;meta&quot;: {&quot;limit&quot;: 20, &quot;next&quot;: null, &quot;offset&quot;: 0, &quot;previous&quot;: null, &quot;total_count&quot;: 1}, &quot;objects&quot;: [{&quot;choices&quot;: [{&quot;choice_text&quot;: &quot;Chain&quot;, &quot;id&quot;: 1, &quot;resource_uri&quot;: &quot;/api/v1/choice/1/&quot;, &quot;votes&quot;: 0}, {&quot;choice_text&quot;: &quot;Ring&quot;, &quot;id&quot;: 2, &quot;resource_uri&quot;: &quot;/api/v1/choice/2/&quot;, &quot;votes&quot;: 0}, {&quot;choice_text&quot;: &quot;Watch&quot;, &quot;id&quot;: 3, &quot;resource_uri&quot;: &quot;/api/v1/choice/3/&quot;, &quot;votes&quot;: 0}], &quot;id&quot;: 1, &quot;pub_date&quot;: &quot;2013-04-10T12:38:47.337475&quot;, &quot;question&quot;: &quot;All gold everything?&quot;, &quot;resource_uri&quot;: &quot;/api/v1/poll/1/&quot;}]}
</code></pre>
<p>Success! Let’s try to post some data. Personally, I prefer gold all in my watch.</p>
<pre><code class="bash">$ curl --dump-header - -H &quot;Authorization: OAuth a832106c17d00fd3b9094181c598820ef3ff76f4&quot; -H &quot;Content-Type: application/json&quot; -X put --data &#39;{&quot;choice_text&quot;: &quot;Watch&quot;, &quot;id&quot;: 3, &quot;resource_uri&quot;: &quot;/api/v1/choice/3/&quot;, &quot;votes&quot;: 1}&#39; http://127.0.0.1:8000/api/v1/choice/3/
HTTP/1.0 204 NO CONTENT
Date: Thu, 11 Apr 2013 00:50:34 GMT
Server: WSGIServer/0.1 Python/2.7.3
Vary: Accept
Content-Length: 0
Content-Type: text/html; charset=utf-8
$ curl --dump-header - -H &quot;Authorization: OAuth a832106c17d00fd3b9094181c598820ef3ff76f4&quot; http://127.0.0.1:8000/api/v1/poll/?format=json
HTTP/1.0 200 OK
Date: Thu, 11 Apr 2013 00:51:36 GMT
Server: WSGIServer/0.1 Python/2.7.3
Vary: Accept
Content-Type: application/json
Cache-Control: no-cache

{&quot;meta&quot;: {&quot;limit&quot;: 20, &quot;next&quot;: null, &quot;offset&quot;: 0, &quot;previous&quot;: null, &quot;total_count&quot;: 1}, &quot;objects&quot;: [{&quot;choices&quot;: [{&quot;choice_text&quot;: &quot;Chain&quot;, &quot;id&quot;: 1, &quot;resource_uri&quot;: &quot;/api/v1/choice/1/&quot;, &quot;votes&quot;: 0}, {&quot;choice_text&quot;: &quot;Ring&quot;, &quot;id&quot;: 2, &quot;resource_uri&quot;: &quot;/api/v1/choice/2/&quot;, &quot;votes&quot;: 0}, {&quot;choice_text&quot;: &quot;Watch&quot;, &quot;id&quot;: 3, &quot;resource_uri&quot;: &quot;/api/v1/choice/3/&quot;, &quot;votes&quot;: 1}], &quot;id&quot;: 1, &quot;pub_date&quot;: &quot;2013-04-10T12:38:47.337475&quot;, &quot;question&quot;: &quot;All gold everything?&quot;, &quot;resource_uri&quot;: &quot;/api/v1/poll/1/&quot;}]}
</code></pre>
<p>Now it shows our updated resource. Our API is now authenticating with OAuth 2.0!</p>
<h2 id="Next-Steps"><a href="#Next-Steps" class="headerlink" title="Next Steps"></a>Next Steps</h2><p>This brief example shows how to get started with your API. Taking your API to the next level you may have some more questions:</p>
<p><strong>How do I manage the scope of the tokens?</strong> Token scope for <code>django-oauth2-provider</code> can be overwritten in your django project’s <code>settings.py</code> file. Use the <a href="https://django-oauth2-provider.readthedocs.org/en/latest/api.html#provider-constants" target="_blank" rel="external">SCOPES</a> setting to define new token scope.</p>
<p><strong>How do I change the lifetime of my tokens?</strong> Similar to scope, you can set the token expiry time in the <code>settings.py</code> as well. Check the <a href="https://django-oauth2-provider.readthedocs.org/en/latest/api.html#provider-constants" target="_blank" rel="external">EXPIRE_DELTA</a> setting to change the token expiry time.</p>
<p><strong>How do I manage authorization permissions?</strong> <code>DjangoAuthorization()</code> is a standard Tasty Pie class. Check the <a href="http://django-tastypie.readthedocs.org/en/latest/authorization.html#djangoauthorization" target="_blank" rel="external">documentation</a> and <a href="https://github.com/toastdriven/django-tastypie/blob/master/tastypie/authorization.py#L131" target="_blank" rel="external">source</a> for more information.</p>
<h2 id="Thank-you"><a href="#Thank-you" class="headerlink" title="Thank you!"></a>Thank you!</h2><p>If you found this useful, please send me a <a href="https://twitter.com/ianalexan" target="_blank" rel="external">tweet</a> or get in contact with me via the top of the page. Good luck!</p>
<div id="disqus_thread"></div></div><div id="footer"><div>designed in san francisco —
licensed as <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/">cc-by-nc-nd</a></div></div></div><script src="https://npmcdn.com/headroom.js@0.8.0/dist/headroom.min.js"></script><script type="text/javascript">var headroom = new Headroom(document.getElementById("nav"));
headroom.init();</script></body></html>